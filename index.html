<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <title>Academic cryptography in France</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webcola@3.4.0/WebCola/cola.min.js"></script>

    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>

    <!-- cola -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-cola@2.5.1/cytoscape-cola.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #cy {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #info-window {
            display: none;
            position: fixed;
            right: 20px;
            top: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 116, 217, 0.3);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            transition: opacity 0.3s ease;
            z-index: 2000;
        }

        .fancy-button {
            position: fixed;
            left: 30px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 116, 217, 0.3);
            border-radius: 8px;
            padding: 12px 20px;
            color: #0074D9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            height: 40px;
        }

        .fancy-button:hover {
            background: rgba(0, 116, 217, 0.1);
            border-color: #0074D9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .fancy-button:active {
            transform: translateY(0);
        }

        #layout-fit {
            top: 30px;
        }

        #reload-layout {
            bottom: 30px;
        }

        .button-icon {
            font-size: 18px;
        }

        .info-header {
            background: #0074D9;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-header h3 { margin: 0; font-size: 18px; font-weight: 500; }

        #info-close {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            opacity: 0.8;
        }
        #info-close:hover { opacity: 1; }

        .info-body { padding: 20px; }

        .info-badge {
            display: inline-block;
            background: #e1f0ff;
            color: #0074D9;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
            border: 1px solid #b3d7ff;
        }

        .info-content strong {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        #info-text {
            margin: 0;
            font-size: 14px;
            line-height: 1.6;
            color: #444;
        }

        .loader {
            width: 45px;
            aspect-ratio: 1;
            --c:no-repeat linear-gradient(#0074D9 0 0);
            background: var(--c), var(--c), var(--c);
            animation:
                l16-1 1s infinite,
                l16-2 1s infinite;
        }
        @keyframes l16-1 {
            0%,100% {background-size:20% 100%}
            33%,66% {background-size:20% 40%}
        }
        @keyframes l16-2 {
            0%,33%   {background-position: 0 0   ,50% 100%,100% 0}
            66%,100% {background-position: 0 100%,50% 0   ,100% 100%}
        }

        #loader-container {
            position: absolute;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
        }

        #search-container {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1500;
            width: 500px;
            font-family: 'Segoe UI', sans-serif;
        }

        .search-box {
            /* height: 40px; */
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 116, 217, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-icon { margin-right: 8px; opacity: 0.6; }

        #node-search {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            color: #333;
            font-size: 14px;
        }

        #search-results {
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .search-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-item:hover {
            background: #0074D9;
            color: white;
        }

        .search-item small { display: block; opacity: 0.7; }

        .icon img {
            position: fixed;
            bottom: 10px;
            right: 15px;
            width: 35px;
            cursor: pointer;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="search-container">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="node-search" placeholder="Rechercher quelqu'un" autocomplete="off">
        </div>
        <div id="search-results"></div>
    </div>

    <div id="loader-container">
        <div class="loader"></div>
    </div>

    <div class="icon" id="github">
        <a href="https://github.com/biskweet/cryptomap">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg">
        </a>
    </div>


    <div id="info-window">
        <div class="info-header">
            <h3 id="info-title">D√©tails de la personne</h3>
            <span id="info-close">&times;</span>
        </div>
        <div class="info-body">
            <div class="info-badge" id="info-year"></div>
            <div class="info-content">
                <strong>D√©tails</strong>
                <p id="info-text"><a id="info-link" target="_blank"></a></p>
            </div>
        </div>
    </div>

    <button id="layout-fit" class="fancy-button">
        <span class="button-text">Ajuster √† la fen√™tre</span>
    </button>

    <button id="reload-layout" class="fancy-button">
        <span class="button-text">Changer le layout</span>
    </button>

    <div id="container">
        <div id="cy"></div>
    </div>

    <script>
        const hideLoader = () => {
            document.getElementById("loader-container").style.display = 'none';
        }

        const showLoader = () => {
            document.getElementById("loader-container").style.display = 'block';
        }

        const layout_data = {
            name: 'cola',
            randomize: false,
            animate: true,
            refresh: 1,
            fit: true,
            infinite: false,
            padding: 30,
            gravity: 0.9,
	    nodeSpacing: (node) => 15 + node.degree() * 2,
        }

        const style_data = [
            {
                selector: 'node',
                style: {
		    // node dimensions
                    'shape': 'round-rectangle',
                    'width': 'label',
                    'height': 'label',
                    'padding': '10px',

		    // node appearance
                    'background-color': '#fff',
                    'border-width': 2,
                    'border-color': '#0074D9',
                    'border-opacity': 0.8,

                    'label': function(node) {
                        return node.data('label') + '\n' + node.data('year');
                    },

                    'text-valign': 'center',
                    'text-halign': 'center',
                    'color': '#333',
                    'font-family': 'Helvetica, Arial, sans-serif',
                    'font-size': '12px',

                    'text-wrap': 'wrap',  // allow \n in labels
                    'text-max-width': '100px',

                    'ghost': 'no',
                    'text-events': 'no',
                }
            },
            {
                selector: '.component',
                style: {
                    'background-color': '#fff7de',
                    'transition-property': 'background-color, line-color',
                    'transition-duration': '0.3s'
                },
            },
            {
                selector: '.neighbors',
                style: {
                    'background-color': '#ffbe8a',
                    'transition-property': 'background-color, line-color',
                    'transition-duration': '0.3s'
                },
            },
            {
                selector: '.focused',
                style: {
                    'background-color': '#FF851B',
                    'transition-property': 'background-color, line-color',
                    'transition-duration': '0.3s'
                },
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#999',
                    'target-arrow-color': '#999',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'straight',
                    'control-point-step-size': 40
                }
            }
        ];

        const makegraph = (elements) => {
            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: style_data,
                layout: { name: 'preset', fit: true }
            });

            cy.layout(layout_data).run();

            const displayInfoWindow = (node) => {
                document.getElementById('info-title').innerText = node.data('label');
                document.getElementById('info-year').innerText = node.data('year')
                    ? "Soutenue en " + node.data('year')
                    : "Pas d'information de soutenance";

                const infoLink = document.getElementById('info-link');
                infoLink.href = "https://theses.fr/" + node.data("id");
                infoLink.innerText = node.data('info') || "Voir le profil sur la page d√©di√©e";
            }

            const hideInfoWindow = () => {
                const infoWindow = document.getElementById('info-window')
                infoWindow.style.opacity = '0';

                infoWindow.style.display = 'none';
            }

            const focus = (node) => {
                const infoWindow = document.getElementById('info-window')
                infoWindow.style.display = 'block';
                infoWindow.style.opacity = '1';

                // Highlight node and its direct connections
                node.addClass('focused');
                node.component().addClass('component');

                const directNeighbors = node.neighborhood();
                directNeighbors.removeClass('component');
                directNeighbors.addClass('neighbors');

                console.log('focused');

                // DIsplay info window
                displayInfoWindow(node);
            }

            const unfocus = () => {
                hideInfoWindow();

                cy.elements().removeClass('component');
                cy.elements().removeClass('neighbors');
                cy.elements().removeClass('focused');
                console.log('unfocused');
            }

            cy.on('tap', 'node', function(evt) {
                const node = evt.target;

                unfocus();
                focus(node);
            });

            cy.on('grab', 'node', function(evt) {
                cy.userPanningEnabled(false);
            });

            cy.on('tap', function(evt) {
                if (evt.target === cy) unfocus();
            });

            cy.on('free', 'node', function() {
                cy.userPanningEnabled(true);
            });


            document.getElementById('info-close').onclick = unfocus;

            document.getElementById('reload-layout').onclick = () => {
                window.alert("This action can be computationally intensive -- please wait 1-2 minutes for the simulation to completely stabilize.")
                showLoader();
                unfocus();
                layout_data.name = 'cose';
                layout_data.refresh = 1e9;
                cy.layout(layout_data).run();
                hideLoader();
                cy.fit();

                focus(tgt);
            };

            document.getElementById('layout-fit').onclick = () => {
                cy.fit();
            };

            window.cy = cy;

            const searchInput = document.getElementById('node-search');
            const resultsContainer = document.getElementById('search-results');

            document.addEventListener('click', e => {
                if (!document.getElementById('search-container').contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });

            cy.on("layoutstart", () => {
                searchInput.disabled = true;
            })

            cy.on("layoutstop", () => {
                cy.fit();
                searchInput.disabled = false;

                searchInput.addEventListener("input", () => {
                    const query = searchInput.value.toLowerCase();
                    resultsContainer.innerHTML = '';

                    const matches = cy.nodes().filter(n => n.data("label").toLowerCase().includes(query));

                    if (matches.length > 0) {
                        resultsContainer.style.display = "block";

                        matches.slice(0, 5).forEach( (node) => {
                            const div = document.createElement("div");
                            div.className = `search-item`;
                            div.innerHTML = `<strong>${ node.data('label') }</strong>` +
                                            `<small>Year ${ node.data('year') || 'unknown' }</small>`;

                            div.onclick = function() {
                                unfocus();
                                focus(node);
                                cy.fit();

                                setTimeout( () => {
                                    cy.animate({
                                        zoom: { level: 1, position: node.position() },
                                        duration: 1000,
                                        easing: 'ease-in-out-quint'
                                    });
                                }, 200);

                                resultsContainer.style.display = 'none';
                                searchInput.value = node.data('label');
                            };

                            resultsContainer.appendChild(div);
                        });
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                });
            })
        }

        fetch("data.json")
            .then(response => response.json())
            .then(makegraph)
            .then(hideLoader)
            .catch(err => console.log(err));
    </script>
</body>
</html>
